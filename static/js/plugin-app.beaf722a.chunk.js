(self.webpackChunkdata_visualizer_app=self.webpackChunkdata_visualizer_app||[]).push([[2143],{3423:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>le});var s=a(1006),n=a.n(s),l=a(2085),i=a(4805),r=a(6609),o=a(2703),u=a(2644),d=a(9551),c=a(7427),p=a(1014),f=a(7538),m=a(1054),v=a(8594),g=a(6206),b=a.n(g),h=a(3665),y=a.n(h);const w={resource:"legendSets",params:e=>{let{ids:t}=e;return{fields:"id,displayName~rename(name),legends[id,displayName~rename(name),startValue,endValue,color]",filter:"id:in:[".concat(t.join(","),"]")}}};var E=a(3064),D=a(4048),q=a(3100),S=a(7363),V=a(8943);const z=e=>(0,V.CU)(S.fW).getPeriods().find((t=>t.id===e[0].id))?S.fW:(0,V.CU)(S.O5).getPeriods().find((t=>t.id===e[0].id))?S.O5:void 0,C=i.vi,x=async(e,t,a)=>{const s=q.Z.getAnalytics(e),n=(new s.request).fromVisualization(t).withParameters(a).withIncludeNumDen(t.type===u.Zp),l=await s.aggregate.get(n);return[new s.response(l)]},P=e=>{let{yearlySeriesRes:t,currentMonth:a,currentDay:s}=e;const n=[],l=[],i=t.metaData.dimensions[C].slice().sort().reverse(),r="02"===a&&"29"===s;return i.forEach((e=>{n.push(t.metaData.items[e].name);const i=29===new Date(e,1,29).getDate();r&&!i?l.push("".concat(e,"-02-28")):l.push("".concat(e,"-").concat(a,"-").concat(s))})),{yearlySeriesLabels:n,periodDates:l}},k=async e=>{let{analyticsEngine:t,visualization:a,options:s,yearlySeriesRes:n,currentMonth:l,currentDay:i}=e;const r=[],o=[],u=n.metaData.dimensions[C].slice().sort().reverse(),d=u.shift();r.push(n.metaData.items[d].name),o.push("".concat(d,"-").concat(l,"-").concat(i));const c=(new t.request).fromVisualization(a).withParameters(s).withRelativePeriodDate("".concat(d,"-").concat(l,"-").concat(i)).withSkipData(!0).withSkipMeta(!1),p=(await t.aggregate.fetch(c)).metaData.dimensions[C].pop(),[f,m]=p.split("W"),v=d-f,g=u.reduce(((e,t)=>(r.push(n.metaData.items[t].name),e.push("".concat(t-v,"W").concat(m)),"53"===m&&e.push("".concat(t-v,"W52")),e)),[]);if(g.length){const e=(new t.request).addPeriodDimension(g).withSkipData(!0).withSkipMeta(!1).withIncludeMetadataDetails(!0),a=await t.aggregate.fetch(e),s=[];a.metaData.dimensions[C].sort().reverse().forEach((e=>{const t=e.substr(0,4);if(!s.includes(t)){const n=new Date(a.metaData.items[e].endDate);n.setDate(n.getDate()+1),o.push("".concat(n.getFullYear(),"-").concat((""+(n.getMonth()+1)).padStart(2,0),"-").concat((""+n.getDate()).padStart(2,0))),s.unshift(t)}}))}return{yearlySeriesLabels:r,periodDates:o}};const O={axes:{requestable:!1,savable:!0,defaultValue:[]},colorSet:{defaultValue:a(222).C7,requestable:!1,savable:!0},cumulativeValues:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyRowItems:{defaultValue:"NONE",requestable:!1,savable:!0},seriesKey:{defaultValue:{},requestable:!1,savable:!0},legend:{defaultValue:{},requestable:!1,savable:!0},noSpaceBetweenColumns:{defaultValue:!1,requestable:!1,savable:!0},percentStackedValues:{defaultValue:!1,requestable:!1,savable:!0},regressionType:{defaultValue:"NONE",requestable:!1,savable:!0},showData:{defaultValue:!0,requestable:!1,savable:!0},aggregationType:{defaultValue:"DEFAULT",requestable:!0,savable:!0},completedOnly:{defaultValue:!1,requestable:!0,savable:!0},hideSubtitle:{defaultValue:!1,requestable:!1,savable:!0},hideTitle:{defaultValue:!1,requestable:!1,savable:!0},sortOrder:{defaultValue:"0",requestable:!1,savable:!0},subtitle:{defaultValue:void 0,requestable:!1,savable:!0},title:{defaultValue:void 0,requestable:!1,savable:!0},series:{defaultValue:[],requestable:!1,savable:!0},fontStyle:{defaultValue:{},requestable:!1,savable:!0},outlierAnalysis:{requestable:!1,savable:!0,defaultValue:null},colTotals:{defaultValue:!1,requestable:!1,savable:!0},colSubTotals:{defaultValue:!1,requestable:!1,savable:!0},rowTotals:{defaultValue:!1,requestable:!1,savable:!0},rowSubTotals:{defaultValue:!1,requestable:!1,savable:!0},showDimensionLabels:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyColumns:{defaultValue:!1,requestable:!1,savable:!0},hideEmptyRows:{defaultValue:!1,requestable:!1,savable:!0},skipRounding:{defaultValue:!1,requestable:!0,savable:!0},numberType:{defaultValue:"VALUE",requestable:!1,savable:!0},showHierarchy:{defaultValue:!1,requestable:!0,savable:!0},displayDensity:{defaultValue:"NORMAL",requestable:!1,savable:!0},fontSize:{defaultValue:"NORMAL",requestable:!1,savable:!0},digitGroupSeparator:{defaultValue:"SPACE",requestable:!1,savable:!0},approvalLevel:{defaultValue:void 0,requestable:!0,savable:!1},fixColumnHeaders:{defaultValue:!1,requestable:!1,savable:!0},fixRowHeaders:{defaultValue:!1,requestable:!1,savable:!0},reportingPeriod:{defaultValue:!1,requestable:!1,savable:!0},organisationUnit:{defaultValue:!1,requestable:!1,savable:!0},parentOrganisationUnit:{defaultValue:!1,requestable:!1,savable:!0},grandParentOrganisationUnit:{defaultValue:!1,requestable:!1,savable:!0},regression:{defaultValue:!1,requestable:!1,savable:!0},cumulative:{defaultValue:!1,requestable:!1,savable:!0},measureCriteria:{defaultValue:void 0,requestable:!0,savable:!0},topLimit:{defaultValue:"0",requestable:!1,savable:!0}},R=()=>Object.entries(O).filter((e=>e[1].requestable)),T=e=>(e||[]).map((e=>{var t;return{...e,items:null==e||null===(t=e.items)||void 0===t?void 0:t.filter((e=>e.id!==E.aW))}})),M=async e=>{let{dataEngine:t,visualization:a,filters:s,forDashboard:n,displayProperty:l}=e;const r={...a,columns:T(a.columns),rows:T(a.rows),filters:T(a.filters)},o=((e,t,a)=>{const s=R().reduce(((t,a)=>{let[s,n]=a;return void 0!==e[s]&&e[s]!==n.defaultValue&&(t[s]=e[s]),t}),{});if(t.relativePeriodDate&&(s.relativePeriodDate=t.relativePeriodDate),a&&(s.displayProperty=a.toUpperCase()),t.userOrgUnit&&t.userOrgUnit.length){const e=t.userOrgUnit.map((e=>e.split("/").slice(-1)[0]));s.userOrgUnit=e.join(";")}return s})(r,s,l),d={dashboard:n};if((0,u.zD)(r.type)){const{responses:e,yearlySeriesLabels:a}=await(async(e,t,a)=>{const s=q.Z.getAnalytics(e);let n=(new s.request).addPeriodDimension(t.yearlySeries).withSkipData(!0).withSkipMeta(!1).withIncludeMetadataDetails(!0);a.relativePeriodDate&&(n=n.withRelativePeriodDate(a.relativePeriodDate));const l=await s.aggregate.fetch(n),i=[],r=[],o=new Date,u=(""+o.getDate()).padStart(2,0),d=(""+(o.getMonth()+1)).padStart(2,0),c=(0,D.Z)(t,C);if(z(c)===S.fW&&!c[0].id===S.uu){const e=await k({analyticsEngine:s,visualization:t,options:a,yearlySeriesRes:l,currentMonth:d,currentDay:u});i.push(...e.periodDates),r.push(...e.yearlySeriesLabels)}else if(z(c)===S.O5){const e=P({yearlySeriesRes:l,currentMonth:d,currentDay:u});i.push(...e.periodDates),r.push(...e.yearlySeriesLabels)}else l.metaData.dimensions[C].sort().reverse().forEach((e=>{r.push(l.metaData.items[e].name),i.push("".concat(e,"-").concat(d,"-").concat(u))}));const p=i.reduce(((e,n)=>{const l=(new s.request).fromVisualization(t).withParameters(a).withRelativePeriodDate(n);return e.push(s.aggregate.get(l)),e}),[]);return Promise.all(p).then((e=>({responses:e.map((e=>new s.response(e))),yearlySeriesLabels:r})))})(t,r,o),s=(0,D.Z)(r,i.vi),n=z(s),l=((e,t)=>{const a=e.reduce(((e,t)=>(e.push(t.metaData.dimensions.pe),e)),[]);if(t===S.O5){a.sort(((e,t)=>e[0].substr(-2)-t[0].substr(-2)));const e=a.shift().map((e=>[e]));return a.forEach((t=>{t.forEach((t=>{const a=t.match(/(\d{4})(\d{2})(\d{2})/),s=a[2],n=a[3],l=e.findIndex((e=>e[0].substr(4)==="".concat(s).concat(n)));if(-1!==l)e[l].push(t);else if("02"===s&&"29"===n){const a=e.findIndex((e=>-1!==e.findIndex((e=>/0228$/.test(e)))));-1!==a?e.splice(a+1,0,[t]):e.push([t])}else e.push([t])}))})),e}if(t===S.fW){a.sort(((e,t)=>t[0].split("W")[1]-e[0].split("W")[1]));const e=a.shift().map((e=>[e]));return a.forEach((t=>{t.forEach((t=>{const[a,s]=t.split("W"),n=e.findIndex((e=>e[0].split("W")[1]===s));if(-1!==n)e[n].push(t);else if("1"===s){const a=e.findIndex((e=>-1!==e.findIndex((e=>/W2$/.test(e)))));-1!==a?e[a].push(t):e.push([t])}else{const n=e.findIndex((e=>-1!==e.findIndex((e=>e==="".concat(a,"W").concat(s-1)))));e.splice(n+1,0,[t])}}))})),e}{const e=a.reduce(((e,t)=>(t.forEach(((t,a)=>{e[a].push(t)})),e)),Array.from({length:a[0].length},(()=>[])));return e}})(e,n),u=l.reduce(((e,t,a)=>(t.forEach((t=>e[t]=a)),e)),{}),c=n?((e,t)=>{switch(t){case S.fW:return e.map((e=>e[0].substr(4))).flat();case S.O5:return e.map((e=>e[0].substr(4).replace(/(\d{2})(\d{2})/,"$2-$1"))).flat()}})(l,n):(e=>{const t=e.reduce(((e,t)=>(e.metaData?t.metaData.dimensions.pe.length>e.metaData.dimensions.pe.length&&(e=t):e=t,e)),{}).metaData;return t.dimensions.pe.reduce(((e,a)=>{const s=t.items[a].name;return e.push(s.replace(/\s+\d{4}$/,"")),e}),[])})(e);return{responses:e,extraOptions:{...d,yearlySeries:a,xAxisLabels:c,periodKeyAxisIndexMap:u}}}return{responses:await x(t,r,o),extraOptions:d}};var L=a(7575);const j=e=>{let{visualization:t,responses:a,extraOptions:s,legendSets:n,id:i,style:r,onChartGenerated:o,animation:d,onToggleContextualMenu:c}=e;const p=(0,l.useRef)(void 0),f=(0,l.useRef)(r),m=(0,l.useRef)(i),v=(0,l.useCallback)((e=>{const l=(0,L.cw)(a,t,p.current,{...s,animation:e,legendSets:n,onToggleContextualMenu:c},void 0,void 0,(0,u.Nh)(t.type)?"dhis":"highcharts");(0,u.Nh)(t.type)?o(l.visualization):o(l.visualization.getSVGForExport({sourceHeight:768,sourceWidth:1024}))}),[p,t,o,c,a,s,n]);return(0,l.useEffect)((()=>{v(d)}),[t,a,s]),(0,l.useEffect)((()=>{i!==m.current&&(v(0),m.current=i)}),[i]),(0,l.useEffect)((()=>{r.width===f.current.width&&r.height===f.current.height||(v(0),f.current=r)}),[r]),l.createElement("div",{ref:p,style:r})};j.defaultProps={visualization:{},filters:{},style:{},animation:200,id:null,onChartGenerated:Function.prototype},j.propTypes={extraOptions:y().object.isRequired,legendSets:y().arrayOf(y().object).isRequired,responses:y().arrayOf(y().object).isRequired,visualization:y().object.isRequired,animation:y().number,id:y().number,style:y().object,onChartGenerated:y().func,onToggleContextualMenu:y().func};const I=j;var _=a(6259),N=a(4196),W=a(9676),Z=a(1463),U=a(4813);const A=e=>{let{style:t={width:18,height:18}}=e;return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:t},l.createElement("path",{d:"M0 0h24v24H0V0z",fill:"none"}),l.createElement("path",{d:"M20 12l-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z",fill:"black"}))};A.propTypes={style:y().object};const F=A,G=e=>{let{style:t={width:18,height:18}}=e;return l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:t},l.createElement("path",{d:"M0 0h24v24H0V0z",fill:"none"}),l.createElement("path",{d:"M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z",fill:"black"}))};G.propTypes={style:y().object};const B=G,H=e=>{let{config:t,ouLevels:a,onClick:s,reference:n,dataTest:i}=e;const o=(0,p.bQ)(),[u,d]=(0,l.useState)(void 0),[c,f]=(0,l.useState)(void 0),m=(0,l.useCallback)((async e=>await(0,r.M7)(o,e)),[o]);(0,l.useEffect)((()=>{d(null);t.ouId&&(async()=>{const e=await m(t.ouId);d(e)})()}),[t]),(0,l.useEffect)((()=>{if(f(null),null!=u&&u.children.length){const t=(e=u.children[0].level,a.find((t=>t.level===e)));t&&f(t)}var e}),[u]);const v={display:"inline-block",minWidth:200};return u?l.createElement(N.r,{reference:n,placement:"right-start",dataTest:i},l.createElement(W.q,null,l.createElement(Z.s,{dense:!0,label:_.Z.t("Change org unit"),dataTest:"".concat(i,"-org-unit")},(null==u?void 0:u.parent)&&l.createElement(l.Fragment,null,l.createElement(Z.s,{dense:!0,icon:l.createElement(B,null),label:l.createElement("span",{style:v},u.parent.name),onClick:()=>s({ou:{id:u.parent.id}}),dataTest:"".concat(i,"-org-unit-drill-up")}),c&&l.createElement(U.i,null)),c&&l.createElement(Z.s,{dense:!0,icon:l.createElement(F,null),label:l.createElement("span",{style:v},_.Z.t("{{level}} level in {{orgunit}}",{level:c.name,orgunit:u.name})),onClick:()=>s({ou:{id:u.id,path:u.path,level:c.id}}),dataTest:"".concat(i,"-org-unit-drill-down")})))):null};H.propTypes={config:y().object,dataTest:y().string,ouLevels:y().array,reference:y().object,onClick:y().func};const K=H;var $=a(7209);const Q=e=>{let{responses:t,legendSets:a,visualization:s,style:n,id:i,onToggleContextualMenu:r}=e;return l.createElement("div",{style:n},l.createElement($.Z,{visualization:s,data:t[0].response,legendSets:a,renderCounter:i,onToggleContextualMenu:r}))};Q.defaultProps={style:{}},Q.propTypes={legendSets:y().arrayOf(y().object).isRequired,responses:y().arrayOf(y().object).isRequired,visualization:y().object.isRequired,id:y().number,style:y().object,onToggleContextualMenu:y().func};const Y=Q,J="VisualizationPlugin_container__zLI-6",X="VisualizationPlugin_chartWrapper__qJc7d",ee="VisualizationPlugin_legendKey__rY4a7",te="VisualizationPlugin_legendKeyToggle__yN1ab",ae="VisualizationPlugin_wrapper__qtDqn",se="VisualizationPlugin_buttonMargin__Zo0d5",ne=e=>{var t,a;let{visualization:s,displayProperty:n,filters:g,forDashboard:h,id:y,style:E,onChartGenerated:D,onError:q,onLoadingComplete:S,onResponsesReceived:V,onDrill:z}=e;const C=(0,p.bQ)(),[x,P]=(0,l.useState)(void 0),[k,O]=(0,l.useState)(null),[R,T]=(0,l.useState)(void 0),[L,j]=(0,l.useState)({}),[_,N]=(0,l.useState)(!1),[W,Z]=(0,l.useState)(0),U=(e,t)=>{if(t.ouId)j(t),T(e);else if(t.category&&(1===s.rows.length&&s.rows[0].dimension===i.rx||2===s.rows.length&&s.rows[1].dimension===i.rx)){var a;const s=null===(a=Object.values(k.responses[0].metaData.items).find((e=>e.name===t.category&&k.responses[0].metaData.dimensions[i.rx].includes(e.uid))))||void 0===a?void 0:a.uid;j({ouId:s}),T(e)}else if(t.category&&s.columns.some((e=>e.dimension===i.rx))){var n;const a=null===(n=Object.values(k.responses[0].metaData.items).find((e=>e.name===t.series&&k.responses[0].metaData.dimensions[i.rx].includes(e.uid))))||void 0===n?void 0:n.uid;j({ouId:a}),T(e)}},A=()=>T(void 0),F=(0,l.useCallback)((async()=>{const e=await M({dataEngine:C,visualization:s,filters:g,forDashboard:h,displayProperty:n});return e.responses.length&&V(e.responses),e}),[C,g,h,n,V,s]),G=(0,l.useCallback)((async e=>{if(!e.length)return[];return await(async(e,t)=>(await e.query({legendSets:w},{variables:{ids:t}})).legendSets.legendSets)(C,e)}),[C]);if((0,l.useEffect)((()=>{(async()=>{const e=await(0,r.qB)(C);P(e)})()}),[C]),(0,l.useEffect)((()=>{O(null);(async()=>{var e,t,a,n;const{responses:l,extraOptions:i}=await F(s,g,h),r=[];switch(null===(e=s.legend)||void 0===e?void 0:e.strategy){case o.zv:null!==(t=s.legend)&&void 0!==t&&null!==(a=t.set)&&void 0!==a&&a.id&&r.push(s.legend.set.id);break;case o.EE:(l[0].metaData.dimensions.dx||[]).forEach((e=>{const t=l[0].metaData.items[e].legendSet;t&&r.push(t)}));break}const u=await G(r);O({visualization:s,legendSets:u,responses:l,extraOptions:i}),N(null===(n=s.legend)||void 0===n?void 0:n.showKey),S()})().catch((e=>{q(e)}))}),[s,g,h]),!k||!x)return null;const B=null==R?void 0:R.getBoundingClientRect(),H=B?{getBoundingClientRect:()=>B}:null;let $=[];switch(null===(t=s.legend)||void 0===t?void 0:t.strategy){case o.EE:{if(!k.visualization.columns.some((e=>"dx"===e.dimension)))break;const e=Object.values(k.responses[0].metaData.items).filter((e=>k.legendSets.map((e=>e.id)).includes(e.legendSet))).map((e=>({itemId:e.uid,legendSet:e.legendSet}))),t=(s.series||[]).filter((e=>e.type===u.Cj)).map((e=>e.dimensionItem));$=k.legendSets.filter((a=>e.filter((e=>!t.includes(e.itemId))).map((e=>e.legendSet)).includes(a.id)))}break;case o.zv:$=k.legendSets}const Q=(null===(a=$)||void 0===a?void 0:a.length)>0&&(0,u.Dm)(k.visualization.type),ne=h&&Q?{...E,width:E.width-(_?200:36)}:E;return l.createElement("div",{className:J},l.createElement("div",{className:X},k.visualization.type&&k.visualization.type!==u.Zp?l.createElement(I,{visualization:(0,c.C)(x,k.visualization),responses:k.responses,extraOptions:k.extraOptions,legendSets:$,onToggleContextualMenu:z?U:void 0,id:h?W:y,onChartGenerated:D,style:ne}):l.createElement(Y,{visualization:(0,c.C)(x,k.visualization),responses:k.responses,legendSets:$,onToggleContextualMenu:z?U:void 0,id:y,style:{...ne,height:ne.height||"100%"}})),Q&&h?l.createElement(l.Fragment,null,_&&l.createElement("div",{className:ee,"data-test":"visualization-legend-key"},l.createElement("div",{className:b()(ae,se)},l.createElement(d.Z,{legendSets:$}))),l.createElement("div",{className:te},l.createElement(f.z,{small:!0,secondary:!0,onClick:()=>{N(!_),Z(W+1)},icon:l.createElement(m.Z,null),toggled:_}))):Q&&null!==(le=k.visualization.legend)&&void 0!==le&&le.showKey?l.createElement("div",{className:ee,"data-test":"visualization-legend-key"},l.createElement("div",{className:ae},l.createElement(d.Z,{legendSets:$}))):void 0,B&&l.createElement(v.m,{onClick:A,dataTest:"visualization-drill-down-backdrop"},l.createElement(K,{reference:H,config:L,ouLevels:x,onClick:e=>{A(),z(e)},dataTest:"visualization-drill-down-menu"})));var le};ne.defaultProps={filters:{},forDashboard:!1,onChartGenerated:Function.prototype,onError:Function.prototype,onLoadingComplete:Function.prototype,onResponsesReceived:Function.prototype,style:{},visualization:{}},ne.propTypes={displayProperty:y().string.isRequired,visualization:y().object.isRequired,filters:y().object,forDashboard:y().bool,id:y().number,style:y().object,onChartGenerated:y().func,onDrill:y().func,onError:y().func,onLoadingComplete:y().func,onResponsesReceived:y().func};const le=()=>{const[e,t]=(0,l.useState)();return(0,l.useEffect)((()=>{n().send(window.top,"getProps").then((e=>t(e.data))).catch((e=>console.error(e)))}),[]),e?l.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},l.createElement(ne,e)):null}},5042:()=>{}}]);