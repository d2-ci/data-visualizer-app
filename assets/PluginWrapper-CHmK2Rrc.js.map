{"version":3,"file":"PluginWrapper-CHmK2Rrc.js","sources":["../../../../node_modules/@dhis2/analytics/build/es/modules/getPWAInstallationStatus.js","../../../../node_modules/@dhis2/analytics/build/es/components/DashboardPluginWrapper/DashboardPluginWrapper.js","../../src/D2App/PluginWrapper.jsx"],"sourcesContent":["export const INSTALLATION_STATES = {\n  READY: 'READY',\n  INSTALLING: 'INSTALLING'\n};\nfunction handleInstallingWorker({\n  installingWorker,\n  onStateChange\n}) {\n  installingWorker.onstatechange = () => {\n    if (installingWorker.state === 'activated') {\n      // ... and update state to 'ready'\n      onStateChange(INSTALLATION_STATES.READY);\n    }\n  };\n}\n\n/**\n * Gets the current installation state of the PWA features, which is intended\n * to be reported from this plugin to the parent app to indicate that the\n * static assets are cached and ready to be accessed locally instead of over\n * the network.\n *\n * Returns either READY, INSTALLING, or `null` for not installed/won't install\n */\nexport async function getPWAInstallationStatus({\n  onStateChange\n}) {\n  if (!navigator.serviceWorker) {\n    // Nothing to do here\n    return null;\n  }\n  const registration = await navigator.serviceWorker.getRegistration();\n  if (!registration) {\n    // This shouldn't happen since this is a PWA app, but return null\n    return null;\n  }\n  if (registration.active) {\n    return INSTALLATION_STATES.READY;\n  }\n  // note that 'registration.waiting' is skipped - it implies there's an active one\n  if (registration.installing) {\n    handleInstallingWorker({\n      installingWorker: registration.installing,\n      onStateChange\n    });\n    return INSTALLATION_STATES.INSTALLING;\n  }\n\n  // It shouldn't normally be possible to get here, but just in case,\n  // listen for installations\n  registration.onupdatefound = () => {\n    // update state for this plugin to 'installing'\n    onStateChange(INSTALLATION_STATES.INSTALLING);\n\n    // also listen for the installing worker to become active\n    const installingWorker = registration.installing;\n    if (!installingWorker) {\n      return;\n    }\n    handleInstallingWorker({\n      installingWorker,\n      onStateChange\n    });\n  };\n\n  // and in the mean time, return null to show 'not installed'\n  return null;\n}","import { useCacheableSection, CacheableSection, useConfig } from '@dhis2/app-runtime';\nimport { CenteredContent, CircularLoader, CssVariables, Layer } from '@dhis2/ui';\nimport PropTypes from 'prop-types';\nimport React, { useEffect } from 'react';\nimport { getPWAInstallationStatus } from '../../modules/getPWAInstallationStatus.js';\nconst LoadingMask = () => {\n  return /*#__PURE__*/React.createElement(Layer, null, /*#__PURE__*/React.createElement(CenteredContent, null, /*#__PURE__*/React.createElement(CircularLoader, null)));\n};\nconst CacheableSectionWrapper = ({\n  id,\n  children,\n  isParentCached = false\n}) => {\n  const {\n    startRecording,\n    isCached,\n    remove\n  } = useCacheableSection(id);\n  useEffect(() => {\n    const shouldStartRecording = isParentCached && !isCached;\n    const shouldRemove = !isParentCached && isCached;\n    if (shouldStartRecording) {\n      startRecording({\n        onError: console.error\n      });\n    }\n    if (shouldRemove) {\n      // Synchronize cache state on load or prop update\n      // -- a back-up to imperative `removeCachedData`\n      remove();\n    }\n  }, [isCached, isParentCached, remove, startRecording]);\n  return /*#__PURE__*/React.createElement(CacheableSection, {\n    id: id,\n    loadingMask: /*#__PURE__*/React.createElement(LoadingMask, null)\n  }, children);\n};\nCacheableSectionWrapper.propTypes = {\n  children: PropTypes.node,\n  id: PropTypes.string,\n  isParentCached: PropTypes.bool\n};\nexport const DashboardPluginWrapper = ({\n  onInstallationStatusChange = Function.prototype,\n  children,\n  cacheId,\n  isParentCached = false,\n  ...props\n}) => {\n  const {\n    pwaEnabled\n  } = useConfig();\n  useEffect(() => {\n    // Get & send PWA installation status now\n    getPWAInstallationStatus({\n      onStateChange: onInstallationStatusChange\n    }).then(onInstallationStatusChange);\n  }, [onInstallationStatusChange]);\n  return props ? /*#__PURE__*/React.createElement(\"div\", {\n    style: {\n      display: 'flex',\n      height: '100%',\n      overflow: 'hidden'\n    }\n  }, pwaEnabled ? /*#__PURE__*/React.createElement(CacheableSectionWrapper, {\n    id: cacheId,\n    isParentCached: isParentCached\n  }, children(props)) : children(props), /*#__PURE__*/React.createElement(CssVariables, {\n    colors: true,\n    spacers: true,\n    elevations: true\n  })) : null;\n};\nDashboardPluginWrapper.propTypes = {\n  cacheId: PropTypes.string,\n  children: PropTypes.func,\n  isParentCached: PropTypes.bool,\n  onInstallationStatusChange: PropTypes.func\n};","import { DashboardPluginWrapper } from '@dhis2/analytics'\nimport debounce from 'lodash-es/debounce'\nimport React, { useLayoutEffect, useState } from 'react'\nimport { VisualizationPluginWrapper } from './components/VisualizationPlugin/VisualizationPluginWrapper.jsx'\nimport './locales/index.js'\n\nconst PluginWrapper = (props) => {\n    const [renderId, setRenderId] = useState(null)\n\n    useLayoutEffect(() => {\n        const updateRenderId = debounce(\n            () =>\n                setRenderId((renderId) =>\n                    typeof renderId === 'number' ? renderId + 1 : 1\n                ),\n            300\n        )\n\n        window.addEventListener('resize', updateRenderId)\n\n        return () => window.removeEventListener('resize', updateRenderId)\n    }, [])\n\n    return (\n        <DashboardPluginWrapper {...props}>\n            {(props) => {\n                return <VisualizationPluginWrapper id={renderId} {...props} />\n            }}\n        </DashboardPluginWrapper>\n    )\n}\n\nexport default PluginWrapper\n"],"names":["INSTALLATION_STATES","handleInstallingWorker","installingWorker","onStateChange","getPWAInstallationStatus","registration","LoadingMask","React","Layer","CenteredContent","CircularLoader","CacheableSectionWrapper","id","children","isParentCached","startRecording","isCached","remove","useCacheableSection","useEffect","shouldStartRecording","shouldRemove","CacheableSection","PropTypes","DashboardPluginWrapper","onInstallationStatusChange","cacheId","props","pwaEnabled","useConfig","CssVariables","PluginWrapper","renderId","setRenderId","useState","useLayoutEffect","updateRenderId","debounce","addEventListener","window","removeEventListener","jsx","VisualizationPluginWrapper"],"mappings":"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","x_google_ignoreList":[0,1]}